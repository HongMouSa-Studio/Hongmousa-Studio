<div class="group lang-switcher-inline">
  
  <!-- Button (Globe Icon + Active Lang Label) -->
  <button class="icon-btn lang-button" aria-label="Language" data-lang="{{ .Site.Language.Lang }}">
    <i class="fa-solid fa-globe"></i>
    <span class="active-lang-label">
      {{ i18n "cur_lang_name" }}
    </span>
    <i class="fa-solid fa-chevron-down chevron-icon"></i>
  </button>

  <!-- Dropdown -->
  <div class="lang-dropdown">

    {{ $curLang := .Site.Language.Lang }}
    {{ $curPath := .Page.RelPermalink }}
    {{ $fromPrefix := printf "/%s/" $curLang }}
    
    {{ range .Site.Languages }}
      {{ $targetPrefix := printf "/%s/" .Lang }}
      {{ $isActive := eq .Lang $curLang }}
      
      {{ if in $curPath $fromPrefix }}
        <a href="{{ replace $curPath $fromPrefix $targetPrefix }}"
           class="lang-option {{ if $isActive }}current-lang{{ end }}" data-lang="{{ .Lang }}"
           onclick="document.cookie='preferred_lang={{ .Lang }};path=/;max-age=31536000';">
          {{ .LanguageName }}
        </a>
      {{ else }}
        <a href="/{{ .Lang }}/"
           class="lang-option {{ if $isActive }}current-lang{{ end }}" data-lang="{{ .Lang }}"
           onclick="document.cookie='preferred_lang={{ .Lang }};path=/;max-age=31536000';">
          {{ .LanguageName }}
        </a>
      {{ end }}
    {{ end }}
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function () {
  const group = document.querySelector('.lang-switcher-inline');
  const button = group.querySelector('.lang-button');
  const dropdown = group.querySelector('.lang-dropdown');
  let leaveTimer;

  let lastOpenTime = 0;

  const openDropdown = () => {
    clearTimeout(leaveTimer);
    dropdown.classList.add("show");
    button.setAttribute('aria-expanded', 'true');
    button.classList.add('active');
    lastOpenTime = Date.now();
  };

  const closeDropdown = () => {
    dropdown.classList.remove("show");
    button.setAttribute('aria-expanded', 'false');
    button.classList.remove('active');
  };

  const toggleDropdown = (e) => {
    if (e) {
      e.stopPropagation();
      e.preventDefault(); // Prevent default button submission/jump
    }
    const isOpen = dropdown.classList.contains('show');
    
    // Fix for Mobile "Double Tap":
    // On touch, 'mouseenter' might fire just before 'click', opening it.
    // Then 'click' sees it's open and closes it immediately.
    // If it was opened very recently (<200ms), assume it was part of this interaction and keep it open.
    if (isOpen) {
      if (Date.now() - lastOpenTime < 200) {
        return; // Keep it open
      }
      closeDropdown();
    } else {
      openDropdown();
    }
  };

  // Hover Interactions (Desktop)
  group.addEventListener('mouseenter', openDropdown);
  group.addEventListener('mouseleave', () => {
    leaveTimer = setTimeout(closeDropdown, 300); // 300ms grace period
  });

  // Click Interactions (Explicit Toggle / Mobile)
  button.addEventListener('click', toggleDropdown);

  // Close when clicking outside
  document.addEventListener('click', function (e) {
    if (!group.contains(e.target)) {
      closeDropdown();
    }
  });

  // Keyboard accessibility
  button.addEventListener('keydown', function (e) {
    if (e.key === 'Enter' || e.key === ' ') {
      e.preventDefault();
      toggleDropdown(e);
    } else if (e.key === 'Escape') {
      closeDropdown();
    }
  });

  // Close after selecting a language
  const options = dropdown.querySelectorAll('.lang-option');
  options.forEach(opt => {
    opt.addEventListener('click', () => {
      closeDropdown();
    });
  });
});
</script>
