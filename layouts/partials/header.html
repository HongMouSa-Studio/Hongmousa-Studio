<header class="site-header">
  
  <div class="header-inner">

    <!-- Mobile/Tablet Menu Toggle (Moved out of actions) -->
    <button class="menu-toggle" aria-label="Toggle Navigation" aria-expanded="false">
      <i class="fa-solid fa-bars"></i>
    </button>

    <!-- Logo + Site Title -->
    <a href="{{ .Site.BaseURL | relLangURL }}" class="logo-block">
      <div>
        <img src="/img/HongMouSa Logo.png" alt="HongMouSa Studio Logo" />
      </div>
    
      <div class="site-title">
        <div class="site-title-l1">Hong-mô͘-sa Kang-chok-sek</div>
        <div class="site-title-l2">芳芼莎工作室</div>
        <div class="site-title-l3">HongMouSa Studio</div>
      </div>
    </a>

    <!-- Desktop Navigation -->
    {{ partial "nav.html" . }}

    <!-- Right Side Actions Group -->
    <div class="header-actions">
      
      <!-- Language Switcher (desktop only) -->
      <div class="lang-desktop">
        {{ partial "lang-switch.html" . }}
      </div>

      <!-- Icons (Search, User, Cart) -->
      <div class="icons-group">

        <!-- Search -->
        <button aria-label="Search" class="icon-btn">
          <i class="fa-solid fa-magnifying-glass"></i>
        </button>

        <!-- Auth (Member Dropdown) -->
        <div class="member-dropdown">

          <!-- Member icon (always visible) -->
          <button class="member-toggle icon-btn" aria-label="User menu">
            <i class="fa-regular fa-user"></i>
          </button>
          
          <!-- Dropdown menu -->
          <div class="member-menu">
            <div class="member-menu-inner">

              <!-- Logged-in info -->
              <div class="member-info auth-only">
                <span class="member-email"></span>
              </div>

              <ul class="member-links">
                <!-- Not logged in -->
                <li class="login-only">
                  <a href="{{ "login/" | relLangURL }}" class="member-link">{{ i18n "member_login" }}</a>
                </li>

                <li class="login-only">
                  <a href="{{ "register/" | relLangURL }}" class="member-link">{{ i18n "member_register" }}</a>
                </li>

                <!-- Logged in -->
                <li class="auth-only">
                  <a href="{{ "account/" | relLangURL }}" class="member-link">{{ i18n "member_my_account" }}</a>
                </li>

                <li class="auth-only">
                  <button id="logout-btn" class="member-link">{{ i18n "account_logout_btn" }}</button>
                </li>
              </ul>
            </div>
          </div>
        </div>

        <!-- Cart (Snipcart Checkout)-->
        <button class="snipcart-checkout icon-btn" aria-label="Cart">
          <i class="fa-solid fa-cart-shopping"></i>
          <!-- Kò͘-bu̍t-chhia sò͘-liōng -->
          <span class="snipcart-items-count cart-count">0</span>
        </button>
      </div>

    </div>
  </div>

  
  <!-- Mobile Hamburger dropdown -->
  <div id="menuMobile" class="menu-mobile">
    
    <nav class="nav-mobile">
      {{ partial "nav-mobile.html" . }}
    </nav>


  </div>
</header>

<script>
document.addEventListener('DOMContentLoaded', function () {
  const btn = document.querySelector('.menu-toggle');
  const icon = btn ? btn.querySelector('i') : null;
  const menu = document.getElementById('menuMobile');

  if (!btn || !menu) return;

  // Hamburger Logic (Click + Hover)
  let menuTimer;

  const showMenu = () => {
    clearTimeout(menuTimer);
    menu.classList.add('show');
    btn.setAttribute('aria-expanded', 'true');
    // Animate Icon
    if (icon) {
      icon.classList.remove('fa-bars');
      icon.classList.add('fa-xmark');
      icon.style.transform = 'rotate(90deg)';
    }
  };


  // Click Toggle
  btn.addEventListener('click', function (e) {
    e.stopPropagation();
    const isOpen = menu.classList.contains('show');
    if (isOpen) {
      hideMenu(true); // Force immediate hide
    } else {
      showMenu();
    }
  });

  const hideMenu = (immediate = false) => {
    const doHide = () => {
      menu.classList.remove('show');
      btn.setAttribute('aria-expanded', 'false');
      if (icon) {
        icon.classList.remove('fa-xmark');
        icon.classList.add('fa-bars');
        icon.style.transform = 'rotate(0deg)';
      }
    };

    if (immediate) {
      clearTimeout(menuTimer);
      doHide();
    } else {
      menuTimer = setTimeout(doHide, 300);
    }
  };

  // Hover Events (Desktop only)
  if (window.matchMedia('(hover: hover)').matches) {
    btn.addEventListener('mouseenter', showMenu);
    btn.addEventListener('mouseleave', () => hideMenu(false));
    menu.addEventListener('mouseenter', showMenu);
    menu.addEventListener('mouseleave', () => hideMenu(false));
  }

  // Auto-close on link click
  menu.querySelectorAll('a').forEach(link => {
    link.addEventListener('click', () => hideMenu(true));
  });

  // Close when clicking outside
  document.addEventListener('click', function (e) {
    if (!menu.classList.contains('show')) return;
    if (menu.contains(e.target) || btn.contains(e.target)) return;
    
    // Force hide
    clearTimeout(menuTimer);
    menu.classList.remove('show');
    btn.setAttribute('aria-expanded', 'false');
    if (icon) {
      icon.classList.remove('fa-xmark');
      icon.classList.add('fa-bars');
      icon.style.transform = 'rotate(0deg)';
    }
  });
  // Member Dropdown Hover Logic with Delay
  const memberGroup = document.querySelector('.member-dropdown');
  const memberBtn   = memberGroup ? memberGroup.querySelector('.member-toggle') : null;
  const memberMenu  = memberGroup ? memberGroup.querySelector('.member-menu') : null;

  if (memberGroup && memberBtn && memberMenu) {
    let memberTimer;

    const showMemberMenu = () => {
      clearTimeout(memberTimer);
      memberMenu.classList.add('show');
      memberBtn.setAttribute('aria-expanded', 'true');
    };

    const hideMemberMenu = () => {
      memberTimer = setTimeout(() => {
        memberMenu.classList.remove('show');
        memberBtn.setAttribute('aria-expanded', 'false');
      }, 300); // 300ms grace period
    };

    memberGroup.addEventListener('mouseenter', showMemberMenu);
    memberGroup.addEventListener('mouseleave', hideMemberMenu);
    
    // Safety: keep open if hovering menu itself
    memberMenu.addEventListener('mouseenter', showMemberMenu);
    memberMenu.addEventListener('mouseleave', hideMemberMenu);
  }
});
</script>
