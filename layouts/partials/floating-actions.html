<div class="fab-container">
  <!-- Sub-actions (Member & Cart) -->
  <div class="fab-actions">
    <!-- Home Button -->
    <a href="{{ "/" | relLangURL }}" class="fab-btn fab-item" aria-label="Home">
      <i class="fa-solid fa-house"></i>
    </a>
    
    <!-- Search Button -->
    <button aria-label="Search" class="fab-btn fab-item">
      <i class="fa-solid fa-magnifying-glass"></i>
    </button>
    
    <!-- Member Dropdown -->
    <div class="member-dropdown fab-item">
      <button class="member-toggle fab-btn" aria-label="User menu">
        <i class="fa-regular fa-user"></i>
      </button>
      
      <div class="member-menu">
        <div class="member-menu-inner">
          <h4 class="member-menu-title auth-only">{{ i18n "member_center" }}</h4>
          <div class="member-info auth-only">
            <span class="member-email"></span>
          </div>
          <ul class="member-links">
            <li class="login-only">
              <a href="{{ "login/" | relLangURL }}" class="member-link">{{ i18n "member_login_register" }}</a>
            </li>
            <li class="auth-only">
              <a href="{{ "account/" | relLangURL }}" class="member-link">{{ i18n "member_my_account" }}</a>
            </li>
            <li class="auth-only">
              <button id="logout-btn" class="member-link">{{ i18n "account_logout_btn" }}</button>
            </li>
          </ul>
        </div>
      </div>
    </div>

    <!-- Cart Button -->
    <button class="snipcart-checkout fab-btn fab-item" aria-label="{{ i18n "nav_cart" }}">
      <svg class="icon-kachi" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
        <defs>
          <clipPath id="bag-shape">
            <!-- Shifted down (Top y=8) to make room for handle -->
            <path d="M1,8 L23,8 L22.5,20 C22.5,22.5 19,23.5 12,23.5 C5,23.5 1.5,22.5 1.5,20 L1,8 Z" />
          </clipPath>
        </defs>
        <!-- Handles (Blue) - Peak at y=2, ends at y=8 -->
        <path d="M6,8 C6,3.5 8.5,2 12,2 C15.5,2 18,3.5 18,8" fill="none" stroke="#003399" stroke-width="2.5" stroke-linecap="round"/>
        <!-- Bag Body Group -->
        <g clip-path="url(#bag-shape)">
          <!-- 3 Simple Horizontal Stripes (Soft/Cute Mode) -->
          <rect x="0" y="8" width="24" height="5" fill="#9ED64B" /> <!-- Top Green (Lighter Brand Green) -->
          <rect x="0" y="13" width="24" height="5" fill="#FF8A8A" /> <!-- Middle Red (Soft Coral) -->
          <rect x="0" y="18" width="24" height="6" fill="#6EB5FF" /> <!-- Bottom Blue (Soft Sky) -->
          
          <!-- Vertical Straps (Start at y=8) -->
          <rect x="4.75" y="8" width="2.5" height="16" fill="#003399" />
          <rect x="16.75" y="8" width="2.5" height="16" fill="#003399" />
        </g>
      </svg>
      <span class="snipcart-items-count cart-count">0</span>
    </button>
  </div>

  <!-- Primary Toggle Bubble -->
  <button class="fab-main-btn" aria-label="Toggle Actions">
    <i class="fa-solid fa-ellipsis"></i>
    <!-- Duplicate cart count for awareness when collapsed -->
    <span class="snipcart-items-count cart-count main-cart-badge">0</span>
  </button>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  const container = document.querySelector('.fab-container');
  const mainBtn = document.querySelector('.fab-main-btn');
  const memberGroup = document.querySelector('.member-dropdown');
  const memberMenu = memberGroup ? memberGroup.querySelector('.member-menu') : null;
  const memberBtn = memberGroup ? memberGroup.querySelector('.member-toggle') : null;

  if (!container || !mainBtn) return;

  // Toggle FAB on Click/Hover
  const toggleFAB = (show) => {
    container.classList.toggle('expanded', show);
  };

  mainBtn.addEventListener('click', (e) => {
    e.stopPropagation();
    container.classList.toggle('expanded');
  });

  // Desktop Hover with Delay
  if (window.matchMedia('(hover: hover)').matches) {
    let fabTimer;
    
    // Open immediately + Clear any close timer
    mainBtn.addEventListener('mouseenter', () => {
      clearTimeout(fabTimer);
      toggleFAB(true);
    });
    
    // Also keep open if moving directly into container (e.g. from button to menu)
    container.addEventListener('mouseenter', () => {
      clearTimeout(fabTimer);
    });

    // Close with delay
    container.addEventListener('mouseleave', () => {
      fabTimer = setTimeout(() => {
        toggleFAB(false);
      }, 300); // 300ms delay: Safe for slower users
    });
  }

  // Member Dropdown logic (Adapted for FAB)
  if (memberGroup && memberMenu && memberBtn) {
    let memberTimer;

    const showMember = () => {
      clearTimeout(memberTimer);
      memberMenu.classList.add('show');
    };

    const hideMember = () => {
      memberTimer = setTimeout(() => {
        memberMenu.classList.remove('show');
      }, 300);
    };

    memberBtn.addEventListener('click', (e) => {
      e.stopPropagation();
      memberMenu.classList.toggle('show');
    });

    if (window.matchMedia('(hover: hover)').matches) {
      memberGroup.addEventListener('mouseenter', showMember);
      memberGroup.addEventListener('mouseleave', hideMember);
    }
  }

  // Ensure main badge is hidden if count is 0
  const mainBadge = document.querySelector('.main-cart-badge');
  const observer = new MutationObserver((mutations) => {
    mutations.forEach((mutation) => {
      const count = parseInt(mutation.target.textContent || "0");
      if (mainBadge) {
        mainBadge.style.display = count > 0 ? 'flex' : 'none';
      }
    });
  });

  const cartCountElem = document.querySelector('.fab-actions .cart-count');
  if (cartCountElem) {
    observer.observe(cartCountElem, { childList: true });
  }

  // Close when clicking outside
  document.addEventListener('click', (e) => {
    if (!container.contains(e.target)) {
      container.classList.remove('expanded');
      if (memberMenu) memberMenu.classList.remove('show');
    }
  });
});
</script>
